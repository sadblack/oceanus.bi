(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-d2eafe1e"],{"2dec":function(t,e,a){"use strict";a("e2636")},c223:function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",[a("dashboardItem",{attrs:{dashboard:t.currentDashboard,mode:"view"}})],1)},n=[],r=a("ce25"),s=a("5fd4"),o={components:{dashboardItem:r["a"]},data:function(){return{currentDashboard:void 0}},created:function(){var t=this;Object(s["i"])(this.$route.params.id).then((function(e){e.data.content=e.data.content,t.currentDashboard=e.data}))}},d=o,c=a("2877"),l=Object(c["a"])(d,i,n,!1,null,null,null);e["default"]=l.exports},ce25:function(t,e,a){"use strict";var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"dashboard-wrapper"},[a("div",{staticClass:"tool-bar"},[a("div",[a("span",{staticClass:"db-name"},[t._v(t._s(t.dashboard.dashborad_name))]),a("span",[t._v(t._s(t.dashboard.dashborad_desc))])]),a("div",{directives:[{name:"show",rawName:"v-show",value:"edit"===t.mode,expression:"mode === 'edit'"}]},[a("el-button",{attrs:{type:"primary",size:"mini"},on:{click:t.handleShare}},[t._v(t._s(t.$t("common.share")))]),a("el-button",{attrs:{type:"primary",size:"mini"},on:{click:t.handleLinkChart}},[t._v(t._s(t.$t("dashboard.addChart")))])],1)]),0!==t.charts.length?a("grid-layout",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticStyle:{"min-height":"500px"},attrs:{layout:t.layout||[],"col-num":24,"row-height":30,"is-draggable":"edit"===t.mode,"is-resizable":"edit"===t.mode,"is-mirrored":!1,"vertical-compact":!0,"pane-container":!1,margin:[10,10],"use-css-transforms":!0},on:{"layout-updated":t.handleLayoutChange}},t._l(t.layout||[],(function(e,i){return a("grid-item",{key:e.index,attrs:{x:e.x,y:e.y,w:e.w,h:e.h,i:e.i},on:{resized:t.handleResize}},[a("el-card",{directives:[{name:"loading",rawName:"v-loading",value:t.chartLoading[e.i],expression:"chartLoading[item.i]"}],staticClass:"visualize-card",attrs:{"body-style":"padding: 10px;"}},[a("div",{staticClass:"operation-bar",attrs:{slot:"header"},slot:"header"},[a("div",{directives:[{name:"show",rawName:"v-show",value:"edit"===t.mode,expression:"mode === 'edit'"}]},[a("a",{attrs:{href:"#"},on:{click:function(a){t.handleEdit(t.getChartItem(e.i))}}},[t._v(t._s(t.getChartItem(e.i).chart_name))])]),a("div",{directives:[{name:"show",rawName:"v-show",value:"view"===t.mode,expression:"mode === 'view'"}]},[a("a",{attrs:{href:"#"}},[t._v(t._s(t.getChartItem(e.i).chart_name))])]),a("div",[a("i",{directives:[{name:"show",rawName:"v-show",value:"edit"===t.mode,expression:"mode === 'edit'"}],staticClass:"el-icon-edit",on:{click:function(a){t.handleEdit(t.getChartItem(e.i))}}}),a("el-dropdown",{attrs:{trigger:"click"}},[a("span",{staticClass:"el-dropdown-link"},[a("i",{staticClass:"el-icon-caret-bottom",attrs:{title:t.$t("common.downdrill")}})]),a("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.getChartItem(e.i).fields,(function(n){return a("el-dropdown-item",{key:n.index,nativeOn:{click:function(a){t.downdrill(t.getChartItem(e.i),n,i)}}},[t._v(t._s(n.field_cname))])})),1)],1),a("i",{directives:[{name:"show",rawName:"v-show",value:"edit"===t.mode,expression:"mode === 'edit'"}],staticClass:"el-icon-delete",on:{click:function(a){t.handleDelete(t.getChartItem(e.i))}}}),a("el-tooltip",{staticClass:"item",attrs:{content:t.getChartItem(e.i).chart_desc,effect:"dark",placement:"top-end"}},[a("i",{staticClass:"el-icon-info",staticStyle:{color:"#409eff",cursor:"pointer"}})])],1)]),a("visualize-panel",{key:e.index,ref:"chartInstance"+e.i,refInFor:!0,attrs:{data:t.results[e.i],schema:t.getChartItem(e.i).content.allSelected,"chart-type":t.getChartItem(e.i).content.chartType,"is-edit-mode":!1,"chart-style":{height:30*e.h+10*(e.h-1)-60+"px"}},on:{"update:chartType":function(a){t.$set(t.getChartItem(e.i).content,"chartType",a)},"update:chart-type":function(a){t.$set(t.getChartItem(e.i).content,"chartType",a)}}})],1)],1)})),1):t._e(),0===t.charts.length&&"edit"===t.mode?a("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"welcome-container"},[a("el-button",{attrs:{type:"primary",size:"mini"},on:{click:t.handleLinkChart}},[t._v(t._s(t.$t("dashboard.addChart")))]),a("div",[a("el-link",{attrs:{type:"info",underline:!1}},[a("router-link",{attrs:{to:"/chartpanel/create"}},[t._v(t._s(t.$t("dashboard.emptyDashboardTip")))])],1)],1)],1):t._e(),a("el-dialog",{attrs:{title:t.$t("chart.myChart"),visible:t.showChartList},on:{"update:visible":function(e){t.showChartList=e}}},[a("div",[a("el-button",{attrs:{type:"primary",size:"mini"},on:{click:function(e){return t.$router.push("/chartpanel/create")}}},[t._v(t._s(t.$t("chart.createNewChart")))]),a("el-table",{attrs:{data:t.myChartList}},[a("el-table-column",{attrs:{label:t.$t("common.name"),width:"200",prop:"chart_name"}}),a("el-table-column",{attrs:{label:t.$t("common.desc"),prop:"desc"}}),a("el-table-column",{attrs:{label:t.$t("common.operation"),align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("el-button",{attrs:{size:"mini",type:"primary",disabled:t.isExisted(e.row)},on:{click:function(a){return t.linkChart(e.row)}}},[t._v(t._s(t.$t("common.add")))]),a("el-button",{attrs:{size:"mini",type:"warning"},on:{click:function(a){return t.$router.push("/chartpanel/"+e.row.chart_id)}}},[t._v(t._s(t.$t("common.edit")))])]}}])})],1),a("pagination",{directives:[{name:"show",rawName:"v-show",value:t.total>0,expression:"total>0"}],attrs:{total:t.total,page:t.queryParams.pageNum,limit:t.queryParams.pageSize},on:{"update:page":function(e){return t.$set(t.queryParams,"pageNum",e)},"update:limit":function(e){return t.$set(t.queryParams,"pageSize",e)},pagination:t.handleLinkChart}}),a("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{attrs:{type:"primary",size:"small"},on:{click:function(e){t.showChartList=!1}}},[t._v(t._s(t.$t("common.close")))])],1)],1)]),a("el-dialog",{attrs:{title:t.sharetitle,visible:t.shareopen,"append-to-body":""},on:{"update:visible":function(e){t.shareopen=e}}},[a("el-form",{ref:"shareform",attrs:{model:t.shareform,"label-width":"120px"}},[a("el-form-item",{attrs:{label:"选择人员",prop:"userids"}},[a("el-select",{attrs:{multiple:"","collapse-tags":"",placeholder:"请选择要分享的人员"},model:{value:t.shareform.userids,callback:function(e){t.$set(t.shareform,"userids",e)},expression:"shareform.userids"}},t._l(t.useroptions,(function(t){return a("el-option",{key:t.userId,attrs:{label:t.nickName,value:t.userId}})})),1)],1)],1),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{attrs:{type:"primary"},on:{click:t.submitShareForm}},[t._v("确 定")]),a("el-button",{on:{click:t.sharecancel}},[t._v("取 消")])],1)],1)],1)},n=[],r=(a("5df3"),a("20d6"),a("7514"),a("ac6a"),a("ade3")),s=a("7be8"),o=a("edf6"),d=a("f77d"),c=a("5fd4"),l=(a("b414"),a("c638")),h=a("a5e0");function u(t,e){var a={x:t[0][0],y:t[0][1]},i={x:t[1][0],y:t[1][1]},n={x:e[0][0],y:e[0][1]},r={x:e[1][0],y:e[1][1]};return a.y===n.y&&i.y===r.y&&(a.x>=n.x&&a.x<=r.x)}var m={components:{GridLayout:s["GridLayout"],GridItem:s["GridItem"],visualizePanel:o["a"]},props:{dashboard:{required:!1,type:Object,default:function(){return{}}},mode:{required:!1,type:String,default:"view"}},data:function(){return Object(r["a"])(Object(r["a"])(Object(r["a"])(Object(r["a"])({charts:[],results:{},loading:!1,layout:[],myChartList:[],showChartList:!1,chartLoading:{},useroptions:[],shareopen:!1,sharetitle:"",shareform:[],fieldList:[]},"loading",!0),"isshow",!1),"total",0),"queryParams",{pageNum:1,pageSize:10,sourceId:void 0,tableName:void 0})},watch:{"dashboard.dashboard_id":{immediate:!0,handler:function(t){t&&this.getList(t)}}},methods:{sharecancel:function(){this.shareopen=!1,this.reset()},reset:function(){this.shareform={userids:void 0,dashboard_id:void 0},this.resetForm("shareform")},handleShare:function(){var t=this;Object(c["h"])(this.queryParams).then((function(e){t.useroptions=e.rows})),this.reset(),this.shareopen=!0,this.sharetitle="数据概览分享",this.shareform.dashboard_id=this.dashboard.dashboard_id},submitShareForm:function(){var t=this,e=this.shareform.userids.join(",");if(this.shareform.userids=e,this.shareform.dashboard_id=this.dashboard.dashboard_id,void 0==this.dashboard.dashboard_id||""==e)return this.msgError("分享失败"),void(this.shareopen=!1);Object(c["l"])(this.shareform).then((function(e){200===e.code&&(t.msgSuccess("分享成功"),t.shareopen=!1)}))},getList:function(){var t=this;this.charts=[],this.layout=[],this.loading=!0,Object(c["c"])(this.dashboard.dashboard_id).then((function(e){t.loading=!1,t.charts=e.data||[];var a=[],i=t.dashboard.content||[];t.charts.forEach((function(e,n){t.$set(t.results,e.chart_id,[]),t.$set(t.chartLoading,e.chart_id,!1),e.content=e.content,e.content.allSelected=[],e.content.allSelected=e.content.allSelected.concat(e.content.selectedCalcul).concat(e.content.selectedDimension),e.content.filters&&(a=e.content.filters.map(h["a"]));var r=Object(h["b"])({dataSrc:e.content.dataSrc,selectedCalcul:e.content.selectedCalcul,selectedDimension:e.content.selectedDimension,orderByStrs:e.content.orderByStrs,filterStr:a.join(" and "),limit:e.content.limit});t.exeSql(r,e,n),i.find((function(t){return t.id===e.chart_id}))||t.generatePosition(e,i,n)})),t.layout=i.filter((function(e){return t.charts.find((function(t){return t.chart_id===e.id}))})),t.handleLayoutChange()}))},getChartItem:function(t){return this.charts.find((function(e){return e.chart_id===t}))},handleCaculPos:function(t){var e=[];return t.forEach((function(t){t.yOffSet=t.y+t.h,t.xOffSet=t.x+t.w,t.bottomLine=[[t.x,t.yOffSet],[t.xOffSet,t.yOffSet]],t.topLine=[[t.x,t.y],[t.xOffSet,t.y]]})),t.forEach((function(a){var i=t.every((function(t){return!u(a.bottomLine,t.topLine)}));i&&e.push(a)})),e},generatePosition:function(t,e,a){var i;if(0===e.length)i={id:t.chart_id,x:0,y:0,w:12,h:9,i:t.chart_id};else{var n=this.handleCaculPos(e),r=n.reduce((function(t,e){return t.bottomLine[0][1]>e.bottomLine[0][1]&&(t=e),t}),n[0]);i={id:t.chart_id,x:r.x,y:r.yOffSet,w:r.w,h:9,i:t.chart_id}}e.push(i)},handleLinkChart:function(){var t=this;this.loading=!0,Object(l["a"])(this.addDateRange(this.queryParams,this.dateRange)).then((function(e){t.myChartList=e.rows,t.showChartList=!0,t.total=e.total,t.loading=!1}))},linkChart:function(t){var e=this,a={chartId:t.chart_id,dashboardId:this.dashboard.dashboard_id};void 0!=this.dashboard.dashboard_id?Object(c["a"])(a).then((function(t){e.showChartList=!1,e.getList(),e.$message({type:"success",message:e.$t("common.saveSuccess")})})):this.$message({type:"error",message:"请先创建看板,然后添加图表"})},isExisted:function(t){return this.charts.findIndex((function(e){return e.chart_id===t.chart_id}))>=0},handleCommand:function(t){t.content.dataSrc,t.source_id},downdrill:function(t,e,a){var i=[],n=this.dashboard.content||[],r={Type:e.field_type,asxAxis:!0,isDimension:!0,Column:e.field_name,cname:e.field_cname,name:e.field_name,lable:e.field_cname,id:e.field_id};t.content.filters&&(i=t.content.filters.map(h["a"]));var s=Object(h["b"])({dataSrc:t.content.dataSrc,selectedCalcul:t.content.selectedCalcul,selectedDimension:r,orderByStrs:t.content.orderByStrs,filterStr:i.join(" and "),limit:t.content.limit});t.content.selectedDimension=r,t.content.allSelected=[],t.content.allSelected=t.content.allSelected.concat(t.content.selectedCalcul).concat(t.content.selectedDimension),t.content.selectedDimension=r,this.exeSql(s,t,a),n.find((function(e){return e.id===t.chart_id}))||this.generatePosition(t,n,a)},handleEdit:function(t){this.$router.push("/chartpanel/".concat(t.chart_id))},handleDelete:function(t){var e=this;this.$confirm(this.$t("dashboard.removeChartConfirm"),this.$t("common.confirm"),{type:"warning"}).then((function(){var a=e.layout.findIndex((function(e){return e.id===t.chart_id})),i=e.layout;i.splice(a,1),e.dashboard.content.layout=i;var n={chartId:t.chart_id,dashboardId:e.dashboard.dashboard_id};Promise.all([Object(c["n"])(e.dashboard),Object(c["m"])(n)]).then((function(t){403!==t.code?(e.getList(),e.$message({type:"success",message:e.$t("common.deleteSuccess")})):e.msgError(t.msg)}))}))},handleLayoutChange:function(){"view"!==this.mode&&(this.dashboard.content=this.layout||{},this.dashboard.content.layout=this.layout,Object(c["n"])(this.dashboard))},handleResize:function(t,e,a,i,n){this.$refs["chartInstance".concat(t)][0].$children[0].$emit("resized")},exeSql:function(t,e,a){var i=this;if(this.$set(this.chartLoading,e.chart_id,!0),!t)return this.$message.warning(this.$t("dashboard.chartQueryException",e.chart_name)),void this.$set(this.chartLoading,e.chart_id,!1);Object(d["b"])({source_id:e.source_id,sql:t}).then((function(t){i.$set(i.chartLoading,e.chart_id,!1),i.$set(i.results,e.chart_id,t.data)})).catch((function(){i.$set(i.chartLoading,e.chart_id,!1)}))}}},f=m,p=(a("2dec"),a("2877")),b=Object(p["a"])(f,i,n,!1,null,"57235442",null);e["a"]=b.exports},e2636:function(t,e,a){}}]);