(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-960eab54"],{"37d5":function(e,t,r){"use strict";r("9343")},5771:function(e,t,r){"use strict";r.r(t);var o=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",[r("el-card",{staticClass:"panel-header",staticStyle:{"margin-bottom":"20px"},attrs:{"body-style":"padding:0;"}},[r("div",{staticStyle:{display:"flex","justify-content":"space-between"},attrs:{slot:"header"},slot:"header"},[r("span",[r("span",{staticClass:"back-button",on:{click:function(t){return e.$router.go(-1)}}},[r("i",{staticClass:"el-icon-back"}),r("span",[e._v(e._s(e.$t("common.back")))])]),"create"!==this.$route.params.id?r("span",[e._v(e._s(e.$t("sqlconsole.createReport")))]):r("span",[e._v(e._s(e.$t("sqlconsole.editReport")))]),r("el-button",{staticStyle:{"margin-left":"10px"},attrs:{size:"mini",type:"text"},on:{click:e.viewAllReport}},[e._v(e._s(e.$t("sqlconsole.allReports")))])],1),r("span",[r("el-button",{staticStyle:{float:"right",margin:"0 10px 0 0"},attrs:{size:"mini",type:"primary",icon:"el-icon-download"},on:{click:e.handleDownload}}),r("el-button",{staticStyle:{float:"right",margin:"0 10px 0 0"},attrs:{size:"mini",type:"primary",icon:"el-icon-save"},on:{click:e.handleSave}},[e._v(e._s(e.$t("sqlconsole.saveReport")))]),"create"!==this.$route.params.id?r("el-button",{staticStyle:{float:"right",margin:"0 10px 0 0"},attrs:{size:"mini",type:"primary"},on:{click:function(t){return e.$router.replace("/sqlconsole/create")}}},[e._v(e._s(e.$t("sqlconsole.createReport")))]):e._e()],1)])]),r("div",{staticClass:"app-container",staticStyle:{display:"flex"}},[r("el-card",{staticStyle:{width:"300px","margin-right":"10px","text-align":"center"},attrs:{id:"dataPanel"}},[r("div",{staticClass:"head-container"},[r("el-select",{attrs:{placeholder:"请选择"},on:{change:function(t){return e.selectds(e.selectds.dsid)}},model:{value:e.selectds.dsid,callback:function(t){e.$set(e.selectds,"dsid",t)},expression:"selectds.dsid"}},e._l(e.dsOptions,(function(e){return r("el-option",{key:e.source_id,attrs:{label:e.base_alias,value:e.source_id}})})),1)],1),r("div",{staticClass:"head-container"},[r("el-tree",{ref:"tree",attrs:{data:e.tableTreeOptions,props:e.defaultProps,"expand-on-click-node":!1,"filter-node-method":e.filterNode}})],1)]),r("el-card",{staticStyle:{width:"100%"},attrs:{"body-style":"padding: 10px 20px;"}},[r("div",{staticClass:"form-wrapper"},[r("el-form",{staticClass:"analysis-form",attrs:{id:"formPanel",size:"mini"}},[r("el-row",{staticClass:"mb8",attrs:{gutter:12}},[r("el-button",{attrs:{type:"success",icon:"el-icon-edit",size:"mini"},on:{click:e.run_sql}},[e._v("运行")]),r("el-button",{attrs:{type:"success",icon:"el-icon-edit",size:"mini"},on:{click:e.formatSqlFun}},[e._v("代码格式化")])],1),r("el-row",{staticClass:"mb8",attrs:{gutter:12}},[r("div",{staticClass:"sql-editor-wrapper"},[r("codemirror",{ref:"codeEditor",attrs:{options:e.editorOptions},model:{value:e.sqlCode,callback:function(t){e.sqlCode=t},expression:"sqlCode"}})],1)])],1),r("el-form",{ref:"reportform",staticClass:"chart-form",attrs:{model:e.reportform,size:"mini","label-position":"top"}},[r("el-form-item",{attrs:{label:e.$t("sqlconsole.reportName")+":"}},[r("el-input",{attrs:{size:"mini",placeholder:e.$t("sqlconsole.namePlaceholder")},model:{value:e.reportform.report_name,callback:function(t){e.$set(e.reportform,"report_name",t)},expression:"reportform.report_name"}})],1),r("el-form-item",{attrs:{label:e.$t("sqlconsole.reportDesc")+":"}},[r("el-input",{attrs:{size:"mini",placeholder:e.$t("sqlconsole.descPlaceholder")},model:{value:e.reportform.report_desc,callback:function(t){e.$set(e.reportform,"report_desc",t)},expression:"reportform.report_desc"}})],1),r("el-form-item",{attrs:{label:e.$t("sqlconsole.isPublic"),prop:"is_public"}},[r("el-checkbox",{attrs:{label:!1},model:{value:e.reportform.is_public,callback:function(t){e.$set(e.reportform,"is_public",t)},expression:"reportform.is_public"}},[e._v(e._s(e.$t("sqlconsole.public")))])],1)],1)],1),r("el-row",{staticClass:"mb8",attrs:{gutter:10}},[r("el-col",{attrs:{span:12}},[r("el-form",{ref:"form",attrs:{size:"mini",model:e.form,rules:e.rules,"label-width":"140px"}},[r("el-form-item",{attrs:{label:"返回记录行数",prop:"returnrows"}},[r("el-input",{staticStyle:{width:"100px"},attrs:{value:100},model:{value:e.form.returnrows,callback:function(t){e.$set(e.form,"returnrows",t)},expression:"form.returnrows"}})],1),r("el-form-item",{attrs:{label:"返回字段中文说明",prop:"field_cnames"}},[r("el-input",{staticStyle:{width:"400px"},attrs:{placeholder:"字段的顺序必须和SQL语句一致,使用英文逗号隔开"},model:{value:e.form.field_cnames,callback:function(t){e.$set(e.form,"field_cnames",t)},expression:"form.field_cnames"}})],1)],1)],1)],1),r("el-row",{staticClass:"mb8",attrs:{gutter:10}},[r("el-tabs",{model:{value:e.message,callback:function(t){e.message=t},expression:"message"}},[r("el-tab-pane",{attrs:{label:"执行结果",name:"result"}},[r("el-table",{attrs:{data:e.tables}},[r("el-table-column",{attrs:{type:"selection"}}),r("el-table-column",{attrs:{label:"序号",type:"index"}}),e._l(e.tableData,(function(e){return[r("el-table-column",{key:e.dataItem,attrs:{sortable:"","show-overflow-tooltip":!0,prop:e.dataItem,label:e.dataName}})]}))],2)],1),r("el-tab-pane",{attrs:{label:"错误信息",name:"errorInfo"}},[r("div",{staticClass:"error"},[r("span",[e._v(e._s(e.errorMsgInfo||"没有错误信息"))])])])],1)],1)],1)],1),r("el-dialog",{attrs:{title:e.$t("sqlconsole.report"),visible:e.showMyReport},on:{"update:visible":function(t){e.showMyReport=t}}},[r("div",[r("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{data:e.myReportList}},[r("el-table-column",{attrs:{label:"报表名称",width:"200",prop:"report_name"}}),r("el-table-column",{attrs:{label:"报表描述",prop:"report_desc"}}),r("el-table-column",{attrs:{label:"操作",width:"200",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[r("el-button",{attrs:{size:"mini",type:"primary",icon:"el-icon-edit"},on:{click:function(r){return e.switchReport(t.row)}}},[e._v(e._s(e.$t("common.edit")))]),r("el-button",{attrs:{size:"mini",type:"danger",icon:"el-icon-delete"},on:{click:function(r){return e.deleteReport(t.row)}}},[e._v(e._s(e.$t("common.delete")))])]}}])})],1),r("pagination",{directives:[{name:"show",rawName:"v-show",value:e.total>0,expression:"total>0"}],attrs:{total:e.total,page:e.queryParams.pageNum,limit:e.queryParams.pageSize},on:{"update:page":function(t){return e.$set(e.queryParams,"pageNum",t)},"update:limit":function(t){return e.$set(e.queryParams,"pageSize",t)},pagination:e.viewAllReport}})],1),r("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[r("el-button",{attrs:{type:"primary",size:"mini"},on:{click:function(t){e.showMyReport=!1}}},[e._v(e._s(e.$t("common.close")))])],1)])],1)},s=[],i=(r("7f7f"),r("ac6a"),r("5df3"),r("4f7f"),r("2909")),a=(r("28a5"),r("a481"),r("8f94")),n=r("db05"),l=r.n(n),c=r("d01e"),u=r("ca17"),d=r.n(u),m=(r("542c"),r("a7be"),r("ffda"),r("991c"),r("31c5"),r("9948"),r("b933"),r("9b74"),r("f6b6"),r("9c7b"),r("715d"),r("23de"),r("4ba6"),r("9a48"),r("697eb"),r("aedd"),r("164b"),r("4895"),r("cbc8"),r("8d70"),r("9f09"),r("a2c1"),r("bd58"),r("8d7e"),["SELECT","DEFAULT","HAVING","LIMIT","COUNT","SUM","AVG","MIN","MAX","DISTINCT","DATEDIFF","BETWEEN","AND","WHERE","FROM","JOIN","USING","CREATE","TABLE","FROM_UNIXTIME","UNIX_TIMESTAMP","NOT","NULL","LIKE","CASE","WHEN","THEN","ELSE","END","ON","UNION","ALL","RIGHT","CAST","AS","OR","DATE","IN","INT","UNSIGNED","OUTER","COALESCE","MINUTES","DAY","INTERVAL","IS","MONTH","HOUR"]),f=["CONCAT","SUBSTR","SUBSTRING_INDEX","YEAR_MONTH","EXTRACT","FLOOR","ROUND","SECONDS","MINITES","IF","IFNULL","GROUP BY","ORDER BY","LOWER","UPPER"],p=r("ed08");_=r("2ef0");var h=/(^|\s+)(from|join)\s+(\S*)$/i,g=[/\sjoin\s+([\w._`]+)\s*(?:as)?\s*([\w_`]+)?/gi,/\sfrom\s+([\w._`]+)\s*(?:as)?\s*([\w_`]+)?/gi],b={name:"sqlEditor",components:{codemirror:a["codemirror"],Treeselect:d.a},props:{},data:function(){var e=this;return{sqlCode:"",editorOptions:{tabSize:4,mode:"text/x-mysql",theme:"xq-light",fullScreen:!1,lineNumbers:!0,line:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],keyMap:"sublime",extraKeys:{F9:function(){e.formatSqlFun()},"Ctrl-space":"autocomplete"},showHitObj:null,currentWord:"",updateTimer:null,sqlSuggestList:[],hintOptions:{completeSingle:!1},sqlSuggestTableNameLists:[],sqlSuggestTableLists:[],sqlSuggestColumns:[],runCur:null},tableTreeOptions:void 0,tableName:void 0,dsOptions:void 0,message:"result",chartType:"table",defaultProps:{children:"children",label:"label"},queryParams:{pageNum:1,pageSize:50,source_id:void 0,sql:"",rows:100,field_cnames:void 0},tables:null,tableData:null,report_name:void 0,report_desc:void 0,errorMsgInfo:"",total:0,loading:!0,showMyReport:!1,myReportList:[],form:{returnrows:200,field_cnames:""},reportform:{report_desc:void 0,report_name:void 0,report_sql:void 0,status:1,source_id:void 0,report_id:void 0,field_cnames:void 0},rules:{returnrows:[{required:!0,message:"返回记录行数不能为空",trigger:"blur"},{pattern:/^(0|[1-9][0-9]*)$/,message:"只能输入数字",trigger:"blur"}],field_cnames:[{required:!0,message:"返回字段中文名称不能为空",trigger:"blur"}]}}},computed:{codemirror:function(){return this.$refs.codeEditor.codemirror}},mounted:function(){this.$refs.codeEditor&&this.$refs.codeEditor.codemirror.on("keyup",this.handleEditorKeyUp)},destroyed:function(){},created:function(){this.getDsList()},watch:{"$route.params.id":{immediate:!0,handler:function(){var e=this;if("create"!==this.$route.params.id){var t=this.$route.params.id;t&&Object(c["c"])(t).then((function(t){e.reportform=t.data,e.sqlCode=t.data.report_sql,e.queryParams.source_id=t.data.source_id,e.form.field_cnames=t.data.field_cnames}))}else this.reportform.report_name=void 0,this.reportform.report_desc=void 0,this.reportform.report_id=void 0,this.sqlCode="",this.reportform.is_public=!1}}},methods:{viewAllReport:function(){var e=this;this.showMyReport=!0,this.loading=!0,Object(c["i"])(this.addDateRange(this.queryParams,this.dateRange)).then((function(t){e.myReportList=t.rows,e.total=t.total,e.loading=!1}))},switchReport:function(e){var t=this;this.$confirm(this.$t("chart.beforeLeaveConfirm"),this.$t("common.confirm")).then((function(){t.$router.replace("/sqlconsole/".concat(e.report_id)),t.showMyReport=!1}))},deleteReport:function(e){var t=this;this.$confirm(this.$t("chart.deleteConfirm",e.report_name),this.$t("common.confirm")).then((function(){reportId(e.report_id).then((function(r){403!==r.code?(t.$route.params.id===e.report_id?(t.$router.push("/sqlconsole/create"),t.showMyReport=!1):t.viewAllReport(),t.$message({type:"success",message:t.$t("common.deleteSuccess")})):t.msgError(r.msg)}))}))},handleDownload:function(){var e=this;Promise.all([r.e("chunk-41515614"),r.e("chunk-58293907")]).then(r.bind(null,"4bf8d")).then((function(t){var r=e.tableData.map((function(e){return e.dataItem})),o=e.tableData.map((function(e){return e.dataName})),s=r,i=e.formatJson(s,e.tables);t.export_json_to_excel({header:o,data:i,filename:"DataExport"+Object(p["b"])(Date.now(),"{m}{d}{h}{i}{s}"),autoWidth:!0})}))},formatJson:function(e,t){return t.map((function(t){return e.map((function(e){var r=e.split(".");return r.length<=1?t[e]:r.reduce((function(e,t){return e[t]?e[t]:"--"}),t)}))}))},handleSave:function(){var e=this;if(void 0!=this.queryParams.source_id)if(""!=this.queryParams.sqlCode){var t=this.reportform.report_id;this.reportform.report_id=t,this.reportform.source_id=this.queryParams.source_id,this.reportform.report_sql=this.sqlCode,this.reportform.field_cnames=this.form.field_cnames,""!=this.form.field_cnames&&void 0!=this.form.field_cnames?t?Object(c["l"])(this.reportform).then((function(t){403!==t.code?e.msgSuccess(e.$t("common.saveSuccess")):e.msgError(t.msg)})):Object(c["a"])(this.reportform).then((function(t){e.msgSuccess(e.$t("common.saveSuccess")),e.$router.replace("/sqlconsole/".concat(t.data.id))})):this.msgError("返回字段的中文名称不能为空")}else this.$message.error("请输入sql语句,然后点击运行");else this.$message.error("请选择左侧的数据源")},getDsList:function(){var e=this;Object(c["e"])().then((function(t){e.dsOptions=t.rows}))},selectds:function(e){var t=this;this.queryParams.source_id=e,Object(c["d"])(e).then((function(e){t.tableTreeOptions=e.data}))},run_sql:function(){var e=this;this.queryParams.sql=this.sqlCode,this.queryParams.rows=this.form.returnrows,this.queryParams.field_cnames=this.form.field_cnames,void 0!=this.queryParams.source_id?""!=this.queryParams.sqlCode?(this.loading=!0,this.$refs["form"].validate((function(t){t&&Object(c["f"])(e.queryParams).then((function(t){if(200===t.code)e.tables=t.data.tables,e.tableData=t.data.tableData,e.total=t.count,e.message="result",store.state,e.loading=!1;else if(400===t.code)return e.loading=!1,e.msgError("SQL执行异常"),e.message="errorInfo",void(e.errorMsgInfo=t.msg)})).catch((function(e){}))}))):this.$message.error("请输入sql语句,然后点击运行"):this.$message.error("请选择左侧的数据源")},getTreeselect:function(){var e=this;tabletreeselect().then((function(t){e.tableTreeOptions=t.data}))},filterNode:function(e,t){return!e||-1!==t.label.indexOf(e)},autocompleteTables:function(e){var t=e.getCursor(),r=this.getToken(e,t),o=r.string.toLowerCase(),s=[];return s=this.getSuggestListByRequsest(this.sqlSuggestTableNameLists,o),this.hintSort(s,o),{list:s,from:a["CodeMirror"].Pos(t.line,r.start),to:a["CodeMirror"].Pos(t.line,r.end)}},getSuggestListByRequsest:function(e,t){for(var r=[],o={},s=0,i=e.length;s<i;s++){var a=e[s].toLowerCase();-1!==a.indexOf(t.trim())&&(o[e[s]]||(r.push(e[s]),o[e[s]]=!0))}return r},autocompleteColumns:function(e){var t=[],r=e.getCursor(),o=this.getToken(e,r),s=o.string.toLowerCase(),n=this.getSuggestListByRequsest(this.sqlSuggestColumns,s);return t=t.concat(n),this.hintSort(t,s),t=Object(i["a"])(new Set(t)),{list:t,from:a["CodeMirror"].Pos(r.line,o.start),to:a["CodeMirror"].Pos(r.line,o.end)}},autoComplete:function(e){var t=m.concat(f),r=e.getCursor(),o=this.getToken(e,r),s=o.string.toLowerCase(),n=[];if(s.indexOf(".")<0){var l=this.getSuggestListByLocal(t,s);n=n.concat(l)}if(s.indexOf(".")<0&&this.systemVars&&this.systemVars.length){var c=this.getSuggestListByLocal(this.systemVars,s);n=n.concat(c)}return this.hintSort(n,s),n=Object(i["a"])(new Set(n)),{list:n,from:a["CodeMirror"].Pos(r.line,o.start),to:a["CodeMirror"].Pos(r.line,o.end)}},getSuggestListByLocal:function(e,t){if(""===t.trim())return[];for(var r={},o=[],s=0,i=e.length;s<i;s++){var a=e[s].toLowerCase();-1!==a.indexOf(t.trim())&&(r[e[s]]||(o.push(e[s]),r[e[s]]=!0))}return o},hintSort:function(e,t){for(var r=0;r<e.Length;r++)for(var o=r;o<e.Length;o++){var s=e[r].toLowerCase(),i=e[o].toLowerCase();if(s.indexOf(t)>i.indexOf(t)){var a=e[r];e[r]=e[o],e[o]=a}}},formatSqlFun:function(){this.sqlCode=l.a.format(this.sqlCode,{})},handleEditorKeyUp:function(e,t){var r=this;this.timer&&clearTimeout(this.timer),this.timer=setTimeout((function(){var o=e.getValue().trim(),s=e.getCursor(),i=r.getToken(e,s),a=i.string.toLowerCase().trim();return"Enter"===t.key||"Tab"===t.key||"Escape"===t.key||""===a?(r.currentWord="",!0):r.currentWord===a&&("ArrowUp"===t.key||"ArrowDown"===t.key)||(r.currentWord=a,r.sqlSuggestColumns=[],r.runCur=s,void r.getSuggestData(e,o,a))}),100)},getToken:function(e,t){var r=e.getTokenAt(t);if(r.string&&(r.string.indexOf(".")>=0||r.string.indexOf("$")>=0)&&t.ch>0){var o=e.getTokenAt({line:t.line,ch:r.start});r.string=(o.string+r.string).trim(),r.start=o.start}return r},getSuggestData:function(e,t,r){var o=e.getCursor();if(""!==r.trim()){var s=this.getTablesAndAlias(t),i=e.getRange({line:0,ch:0},o);h.test(i)?this.getHintTables():s.length?this.getHintColumns(s,r):this.showSuggestMenu("local")}},getHintTables:function(){this.sqlSuggestTableNameLists=["aaa","bbb","ccc","def","table1","table2","table3","table4","ghy"],this.showSuggestMenu("table")},getHintColumns:function(e,t){var r,o,s=[],a={},n=t.indexOf(".");-1!==n?(o=t.substr(0,n),e.forEach((function(e,t){e.alias===o&&(r=e.name)})),r&&(a.tables=[r],this.getColumnList())):(e.forEach((function(e,t){""!==e.name&&s.push(e.name)})),s=Object(i["a"])(new Set(s)),a.tables=s,s.length&&this.getColumnList({body:a}))},getColumnList:function(){this.sqlSuggestColumns=["user","age","name","id","abc","efg","hij","klm","nuv","wh"],this.showSuggestMenu("column")},isLegalAlias:function(e){var t={where:1,on:1,using:1,join:1,group:1,order:1,limit:1};return!t[e.toLowerCase()]},getTablesAndAlias:function(e){for(var t=m.concat(f),r=[],o=0;o<g.length;o++)for(var s=g[o];;){var i=s.exec(e);if(!i)break;s.lastIndex=i.index+1;var a=i[1],n="";i[2]&&(n=i[2].toLowerCase(),this.isLegalAlias(n)||(n="")),-1===t.indexOf(a.toUpperCase())&&r.push({name:a,alias:n})}return r},showSuggestMenu:function(e){var t;if(this.runCur){var r=this.codemirror.getCursor();if(!_.isEqual(this.runCur,r))return}"local"==e?t=this.autoComplete:"table"==e?t=this.autocompleteTables:"column"==e&&(t=this.autocompleteColumns),this.$refs.codeEditor&&this.$refs.codeEditor.codemirror&&a["CodeMirror"].showHint(this.$refs.codeEditor.codemirror,t)}}},v=b,y=(r("37d5"),r("2877")),C=Object(y["a"])(v,o,s,!1,null,"1519adb0",null);t["default"]=C.exports},9343:function(e,t,r){},d01e:function(e,t,r){"use strict";r.d(t,"f",(function(){return s})),r.d(t,"b",(function(){return i})),r.d(t,"j",(function(){return a})),r.d(t,"e",(function(){return n})),r.d(t,"d",(function(){return l})),r.d(t,"l",(function(){return c})),r.d(t,"a",(function(){return u})),r.d(t,"c",(function(){return d})),r.d(t,"h",(function(){return m})),r.d(t,"g",(function(){return f})),r.d(t,"k",(function(){return p})),r.d(t,"i",(function(){return h}));var o=r("b775");function s(e){return Object(o["a"])({url:"/rest/report/sql_exec",method:"post",data:e})}function i(e){return Object(o["a"])({url:"/rest/report/remove/".concat(e),method:"delete"})}function a(e){return Object(o["a"])({url:"/rest/report/reportresult",method:"get",params:e})}function n(){return Object(o["a"])({url:"/rest/bi/datasource/list",method:"get"})}function l(e){return Object(o["a"])({url:"/rest/bi/datasource/tabletree/"+e,method:"get"})}function c(e){return Object(o["a"])({url:"/rest/report/update",method:"put",data:e})}function u(e){return Object(o["a"])({url:"/rest/report/create",method:"post",data:e})}function d(e){return Object(o["a"])({url:"/rest/report/query/"+e,method:"get"})}function m(){return Object(o["a"])({url:"/rest/report/publictree"})}function f(){return Object(o["a"])({url:"/rest/report/myreporttree/"})}function p(e){return Object(o["a"])({url:"/rest/report/share",method:"get",params:e})}function h(e){return Object(o["a"])({url:"/rest/report/list",method:"get",params:e})}}}]);